package src.envy;

import jason.NoValueException;
import jason.asSyntax.Literal;
import jason.asSyntax.NumberTerm;
import jason.asSyntax.Structure;
import jason.environment.*;
import jason.environment.grid.Location;

import java.util.HashMap;
import java.util.Map;
import java.util.logging.Logger;

public class myEnvironment extends Environment {

    private Logger logger = Logger.getLogger("project."+myEnvironment.class.getName());

    //Our CityGML parser jar...

    private AgentModel agentModel;
    private AgentView agentView;
    private Map<String, String> gridMap;
    //private int GRID_SIZE;
    //public static int GRID_SIZE = 40;
    public static int AGENTS = 10;

    private int gridSize;

    public void init(String[] args) {
        gridMap = new HashMap<>();

        // Sample coordinates
        String coordinates = "26.17245647\t41.27278463\n" +
                "26.22752268\t40.51354437\n" +
                "26.54903081\t41.22390683\n" +
                "30.48273651\t41.64881188\n" +
                "30.31734603\t43.97490235\n" +
                "26.01823487\t43.67490428\n" +
                "26.01823487\t43.67490428\n" +
                "30.31734603\t43.97490235\n" +
                "30.15195555\t46.30099281\n" +
                "25.86401327\t46.07702394\n" +
                "25.86401327\t46.07702394\n" +
                "30.15195555\t46.30099281\n" +
                "29.98656506\t48.62708327\n" +
                "25.70979167\t48.47914359\n" +
                "25.70979167\t48.47914359\n" +
                "29.98656506\t48.62708327\n" +
                "29.82117458\t50.95317374\n" +
                "25.55557007\t50.88126325\n" +
                "25.55557007\t50.88126325\n" +
                "29.82117458\t50.95317374\n" +
                "29.6557841\t53.2792642\n" +
                "25.40134846\t53.2833829\n" +
                "25.40134846\t53.2833829\n" +
                "29.6557841\t53.2792642\n" +
                "29.49039362\t55.60535467\n" +
                "25.24712686\t55.68550256\n" +
                "13.19562079\t55.57446161\n" +
                "13.3798239\t53.03866768\n" +
                "18.30520908\t53.16755919\n" +
                "18.13350239\t55.61566346\n" +
                "13.3798239\t53.03866768\n" +
                "13.56402701\t50.50287376\n" +
                "17.89409937\t50.72467204\n" +
                "18.4939991\t49.74609756\n" +
                "18.47691578\t50.71945492\n" +
                "18.30520908\t53.16755919\n" +
                "18.55399418\t48.47520184\n" +
                "18.2090177\t46.9053777\n" +
                "17.43846139\t45.39387313\n" +
                "16.33720006\t44.21510208\n" +
                "14.94667275\t43.32801107\n" +
                "12.55771292\t42.50098045\n" +
                "10.08872249\t41.70815873\n" +
                "6.302022571\t40.90432364\n" +
                "6.012573688\t36.01900788\n" +
                "7.497720681\t36.24068648\n" +
                "8.733792128\t36.1740711\n" +
                "10.46147834\t35.61300234\n" +
                "11.70585807\t35.07801232\n" +
                "12.79818336\t34.1092744\n" +
                "13.67441267\t33.12309127\n" +
                "14.28037351\t31.88563634\n" +
                "15.2378297\t29.45156982\n" +
                "16.73946916\t24.86247926\n" +
                "23.60373413\t24.73117015\n" +
                "24.01578862\t26.6613029\n" +
                "24.67212622\t27.97583971\n" +
                "25.79080954\t29.17368913\n" +
                "26.6042019\t29.92125254\n" +
                "27.8735284\t30.69401881\n" +
                "29.29139375\t31.21914181\n" +
                "30.5185181\t31.58187134\n" +
                "33.1335952\t35.73707619\n" +
                "31.05487287\t35.7722906\n" +
                "30.16433624\t35.91655285\n" +
                "29.27143833\t36.24929123\n" +
                "27.91249079\t36.99014233\n" +
                "26.80749609\t38.16628503\n" +
                "26.21115435\t39.66812401\n" +
                "26.22752268\t40.51354437\n" +
                "26.17245647\t41.27278463\n" +
                "26.01823487\t43.67490428\n" +
                "25.86401327\t46.07702394\n" +
                "25.70979167\t48.47914359\n" +
                "25.55557007\t50.88126325\n" +
                "18.47691578\t50.71945492\n" +
                "18.4939991\t49.74609756\n" +
                "18.13350239\t55.61566346\n" +
                "18.47691578\t50.71945492\n" +
                "18.4939991\t49.74609756\n" +
                "25.55557007\t50.88126325\n" +
                "25.40134846\t53.2833829\n" +
                "25.24712686\t55.68550256\n" +
                "0.5717517617\t39.21188283\n" +
                "1.053258984\t34.71510932\n" +
                "6.012573688\t36.01900788\n" +
                "6.302022571\t40.90432364\n" +
                "16.73946916\t24.86247926\n" +
                "17.54489894\t22.08937523\n" +
                "18.27664408\t19.64494485\n" +
                "18.86266587\t17.58718947\n" +
                "21.62736343\t2.83941371\n" +
                "22.24769508\t0.1281244922\n" +
                "26.95912249\t0.1892399387\n" +
                "23.50058079\t18.15828567\n" +
                "23.40828813\t18.7011378\n" +
                "23.378425\t20.74173287\n" +
                "23.4608659\t22.80551021\n" +
                "23.60373413\t24.73117015\n" +
                "30.5185181\t31.58187134\n" +
                "31.88875371\t31.75293997\n" +
                "34.05314268\t31.78406814\n" +
                "43.49600691\t31.53665352\n" +
                "43.52400192\t35.36391365\n" +
                "42.914549\t35.39698643\n" +
                "40.18033048\t35.43933005\n" +
                "35.55088905\t35.61349203\n" +
                "33.1335952\t35.73707619\n" +
                "13.19562079\t55.57446161\n" +
                "9.872966792\t55.54152978\n" +
                "10.58825966\t47.07547526\n" +
                "0\t44.0640792\n" +
                "0.3638441875\t40.95877969\n" +
                "3.674762741\t41.83695751\n" +
                "6.302022571\t40.90432364\n" +
                "10.08872249\t41.70815873\n" +
                "12.55771292\t42.50098045\n" +
                "14.94667275\t43.32801107\n" +
                "16.33720006\t44.21510208\n" +
                "17.43846139\t45.39387313\n" +
                "18.2090177\t46.9053777\n" +
                "18.55399418\t48.47520184\n" +
                "18.4939991\t49.74609756\n" +
                "17.89409937\t50.72467204\n" +
                "13.56402701\t50.50287376\n" +
                "43.51975332\t40.28176169\n" +
                "43.55272601\t42.47686436\n" +
                "34.79411872\t42.71506928\n" +
                "33.96221587\t55.68763324\n" +
                "31.38666979\t55.69937135\n" +
                "32.28939328\t41.70712834\n" +
                "30.48273651\t41.64881188\n" +
                "26.54903081\t41.22390683\n" +
                "26.22752268\t40.51354437\n" +
                "26.21115435\t39.66812401\n" +
                "26.80749609\t38.16628503\n" +
                "27.91249079\t36.99014233\n" +
                "29.27143833\t36.24929123\n" +
                "30.16433624\t35.91655285\n" +
                "31.05487287\t35.7722906\n" +
                "33.1335952\t35.73707619\n" +
                "35.55088905\t35.61349203\n" +
                "35.97258285\t36.80497256\n" +
                "35.71776736\t38.34125716\n" +
                "34.79395388\t40.56706671\n" +
                "36.90315683\t40.49519124\n" +
                "39.77018989\t40.42015387\n" +
                "28.91740071\t0.2213338139\n" +
                "37.45614147\t0.3789277924\n" +
                "31.48219152\t27.47396448\n" +
                "43.47762135\t27.12698883\n" +
                "43.45070188\t29.55104015\n" +
                "32.77280822\t29.80936985\n" +
                "31.89135977\t30.78788302\n" +
                "30.5185181\t31.58187134\n" +
                "29.29139375\t31.21914181\n" +
                "27.8735284\t30.69401881\n" +
                "26.6042019\t29.92125254\n" +
                "25.79080954\t29.17368913\n" +
                "24.67212622\t27.97583971\n" +
                "24.01578862\t26.6613029\n" +
                "23.60373413\t24.73117015\n" +
                "23.4608659\t22.80551021\n" +
                "23.378425\t20.74173287\n" +
                "23.40828813\t18.7011378\n" +
                "23.8711\t18.01247942\n" +
                "25.58851729\t16.80790281\n" +
                "6.012573688\t36.01900788\n" +
                "4.476678347\t33.84884108\n" +
                "1.260305229\t33.13129264\n" +
                "1.559797571\t30.07064407\n" +
                "8.424279739\t31.75649438\n" +
                "14.87360472\t0\n" +
                "22.24769508\t0.1281244922\n" +
                "21.62736343\t2.83941371\n" +
                "19.81735644\t4.045857413\n" +
                "17.41773908\t15.29798705\n" +
                "18.86266587\t17.58718947\n" +
                "18.27664408\t19.64494485\n" +
                "17.54489894\t22.08937523\n" +
                "16.73946916\t24.86247926\n" +
                "15.2378297\t29.45156982\n" +
                "14.28037351\t31.88563634\n" +
                "13.67441267\t33.12309127\n" +
                "12.79818336\t34.1092744\n" +
                "11.70585807\t35.07801232\n" +
                "10.46147834\t35.61300234\n" +
                "8.733792128\t36.1740711\n" +
                "7.497720681\t36.24068648\n" +
                "43.51975332\t40.28176169\n" +
                "39.77018989\t40.42015387\n" +
                "42.914549\t35.39698643\n" +
                "43.52400192\t35.36391365\n" +
                "39.77018989\t40.42015387\n" +
                "36.90315683\t40.49519124\n" +
                "40.18033048\t35.43933005\n" +
                "42.914549\t35.39698643\n" +
                "36.90315683\t40.49519124\n" +
                "34.79395388\t40.56706671\n" +
                "35.71776736\t38.34125716\n" +
                "35.97258285\t36.80497256\n" +
                "35.55088905\t35.61349203\n" +
                "40.18033048\t35.43933005";

        // Parse and map the coordinates
        parseAndMapCoordinates(coordinates);

        // Set the calculated grid size
        agentModel = new AgentModel(gridSize, AGENTS);
        agentView = new AgentView(agentModel);
        agentModel.setView(agentView);

        // Set coordinates on the model
        agentModel.setCoordinates(gridMap);

        // Display the agent view
        agentView.setVisible(true);

        logger.info("Env init");
    }

    private void parseAndMapCoordinates(String coordinates) {
        String[] lines = coordinates.split("\n");
        double minLat = Double.MAX_VALUE, maxLat = Double.MIN_VALUE;
        double minLon = Double.MAX_VALUE, maxLon = Double.MIN_VALUE;

        // First pass: determine the min and max values
        for (String line : lines) {
            String[] parts = line.split("\\s+");
            double lat = Double.parseDouble(parts[0]);
            double lon = Double.parseDouble(parts[1]);

            if (lat < minLat) minLat = lat;
            if (lat > maxLat) maxLat = lat;
            if (lon < minLon) minLon = lon;
            if (lon > maxLon) maxLon = lon;
        }

        // Calculate the optimal grid size
        double latRange = maxLat - minLat;
        double lonRange = maxLon - minLon;
        gridSize = (int) Math.ceil(Math.max(latRange, lonRange));

        // Second pass: normalize and map to grid
        for (String line : lines) {
            String[] parts = line.split("\\s+");
            double lat = Double.parseDouble(parts[0]);
            double lon = Double.parseDouble(parts[1]);

            int gridX = (int) ((lat - minLat) / latRange * (gridSize - 1));
            int gridY = (int) ((lon - minLon) / lonRange * (gridSize - 1));

            String gridKey = gridX + "," + gridY;
            gridMap.put(gridKey, line);
        }
    }

    @Override
    public void stop(){
        super.stop();
    }

}
